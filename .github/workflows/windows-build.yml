name: Build Windows installer

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build Next.js standalone
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: http://localhost:3000

      - name: Prepare standalone for packaging
        shell: pwsh
        run: |
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "PREPARING STANDALONE BUILD" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          
          # Verify standalone exists
          if (-not (Test-Path ".next/standalone")) {
            Write-Host "FATAL: .next/standalone not found!" -ForegroundColor Red
            exit 1
          }
          
          Write-Host "`n[1/4] Standalone directory found" -ForegroundColor Yellow
          Get-ChildItem ".next/standalone" | ForEach-Object { Write-Host "  - $_" }
          
          # Copy static files
          Write-Host "`n[2/4] Copying static files..." -ForegroundColor Yellow
          if (Test-Path ".next/static") {
            New-Item -ItemType Directory -Force -Path ".next/standalone/.next/static" | Out-Null
            Copy-Item -Recurse -Force ".next/static/*" ".next/standalone/.next/static/"
            Write-Host "  Static files copied to .next/standalone/.next/static/"
            Get-ChildItem ".next/standalone/.next/static" | ForEach-Object { Write-Host "    - $_" }
          } else {
            Write-Host "  WARNING: .next/static not found!" -ForegroundColor Yellow
          }
          
          # Copy public folder
          Write-Host "`n[3/4] Copying public folder..." -ForegroundColor Yellow
          if (Test-Path "public") {
            New-Item -ItemType Directory -Force -Path ".next/standalone/public" | Out-Null
            Copy-Item -Recurse -Force "public/*" ".next/standalone/public/"
            Write-Host "  Public folder copied to .next/standalone/public/"
            Get-ChildItem ".next/standalone/public" | ForEach-Object { Write-Host "    - $_" }
          } else {
            Write-Host "  WARNING: public folder not found!" -ForegroundColor Yellow
          }
          
          # Create .env file
          Write-Host "`n[4/4] Creating .env file..." -ForegroundColor Yellow
          @"
DATABASE_URL=file:./data.db
NEXTAUTH_SECRET=electron-desktop-secret-change-in-production
NEXTAUTH_URL=http://localhost:3000
"@ | Out-File -FilePath ".next/standalone/.env" -Encoding ASCII -NoNewline
          Write-Host "  .env created"
          
          # Final verification
          Write-Host "`n========================================" -ForegroundColor Green
          Write-Host "FINAL STANDALONE STRUCTURE" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          
          Write-Host "`nRoot files:"
          Get-ChildItem ".next/standalone" -File | ForEach-Object { Write-Host "  [FILE] $_" }
          
          Write-Host "`nRoot directories:"
          Get-ChildItem ".next/standalone" -Directory | ForEach-Object { Write-Host "  [DIR]  $_" }
          
          if (Test-Path ".next/standalone/.next") {
            Write-Host "`n.next/ contents:"
            Get-ChildItem ".next/standalone/.next" | ForEach-Object { Write-Host "  - $_" }
          }
          
          # Verify critical files
          Write-Host "`n========================================" -ForegroundColor Green
          Write-Host "CRITICAL FILE CHECK" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          
          $critical = @(
            ".next/standalone/server.js",
            ".next/standalone/.next/static",
            ".next/standalone/public"
          )
          
          $allGood = $true
          foreach ($item in $critical) {
            if (Test-Path $item) {
              Write-Host "  [OK] $item" -ForegroundColor Green
            } else {
              Write-Host "  [MISSING] $item" -ForegroundColor Red
              $allGood = $false
            }
          }
          
          if (-not $allGood) {
            Write-Host "`nFATAL: Missing critical files!" -ForegroundColor Red
            exit 1
          }
          
          Write-Host "`nStandalone preparation COMPLETE" -ForegroundColor Green

      - name: Package Electron for Windows
        run: npx electron-builder --win --x64 --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Show build output
        shell: pwsh
        run: |
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "BUILD ARTIFACTS" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          
          if (Test-Path "dist") {
            Get-ChildItem "dist" -Recurse | Where-Object { $_.Extension -in '.exe', '.zip' } | ForEach-Object {
              $sizeMB = [math]::Round($_.Length / 1MB, 2)
              Write-Host "  $($_.Name) - $sizeMB MB"
            }
          } else {
            Write-Host "  No dist folder found" -ForegroundColor Red
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installers
          path: |
            dist/*.exe
            dist/*.zip
          retention-days: 30
