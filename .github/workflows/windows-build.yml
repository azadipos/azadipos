name: Build Windows installer

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build Next.js (standalone)
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: http://localhost:3000

      - name: Prepare standalone build for Electron
        shell: pwsh
        run: |
          Write-Host "=== Preparing Next.js standalone for Electron ===" -ForegroundColor Green
          
          # Verify standalone was created
          if (-not (Test-Path ".next/standalone")) {
            Write-Host "ERROR: .next/standalone directory not found!" -ForegroundColor Red
            exit 1
          }
          
          Write-Host "Standalone directory found. Contents:"
          Get-ChildItem ".next/standalone" | ForEach-Object { Write-Host "  $_" }
          
          # Copy static files into standalone/.next/static
          Write-Host "`nCopying .next/static to standalone..." -ForegroundColor Yellow
          if (Test-Path ".next/static") {
            New-Item -ItemType Directory -Force -Path ".next/standalone/.next/static" | Out-Null
            Copy-Item -Recurse -Force ".next/static/*" ".next/standalone/.next/static/"
            Write-Host "Static files copied successfully"
          } else {
            Write-Host "WARNING: .next/static not found" -ForegroundColor Yellow
          }
          
          # Copy public folder into standalone/public
          Write-Host "`nCopying public folder to standalone..." -ForegroundColor Yellow
          if (Test-Path "public") {
            New-Item -ItemType Directory -Force -Path ".next/standalone/public" | Out-Null
            Copy-Item -Recurse -Force "public/*" ".next/standalone/public/"
            Write-Host "Public folder copied successfully"
          } else {
            Write-Host "WARNING: public folder not found" -ForegroundColor Yellow
          }
          
          # Create .env file in standalone
          Write-Host "`nCreating .env in standalone..." -ForegroundColor Yellow
          @"
          DATABASE_URL=file:./pos.db
          NEXTAUTH_SECRET=electron-local-secret-key-change-me
          NEXTAUTH_URL=http://localhost:3000
          "@ | Out-File -FilePath ".next/standalone/.env" -Encoding UTF8
          
          # Verify final structure
          Write-Host "`n=== Final standalone structure ===" -ForegroundColor Green
          Write-Host "Root:"
          Get-ChildItem ".next/standalone" | ForEach-Object { Write-Host "  $_" }
          
          if (Test-Path ".next/standalone/.next") {
            Write-Host ".next:"
            Get-ChildItem ".next/standalone/.next" | ForEach-Object { Write-Host "    $_" }
          }
          
          if (Test-Path ".next/standalone/.next/static") {
            Write-Host ".next/static:"
            Get-ChildItem ".next/standalone/.next/static" | ForEach-Object { Write-Host "      $_" }
          }
          
          if (Test-Path ".next/standalone/public") {
            Write-Host "public:"
            Get-ChildItem ".next/standalone/public" | ForEach-Object { Write-Host "    $_" }
          }
          
          Write-Host "`nStandalone build prepared successfully!" -ForegroundColor Green

      - name: Package Electron (Windows)
        run: npx electron-builder --win --x64 --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List build output
        shell: pwsh
        run: |
          Write-Host "=== Build artifacts ===" -ForegroundColor Green
          if (Test-Path "dist") {
            Get-ChildItem "dist" -Recurse | Where-Object { $_.Extension -in '.exe', '.zip' } | ForEach-Object {
              Write-Host "$($_.Name) - $([math]::Round($_.Length / 1MB, 2)) MB"
            }
          } else {
            Write-Host "No dist folder found"
          }

      - name: Upload installers
        uses: actions/upload-artifact@v4
        with:
          name: windows-installers
          path: |
            dist/*.exe
            dist/*.zip
          retention-days: 30
