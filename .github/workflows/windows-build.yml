name: Build Windows Installers

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install main app dependencies
        run: npm install --legacy-peer-deps

      - name: Generate Prisma Client for Windows
        run: npx prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Build Next.js standalone
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: http://localhost:3000

      - name: Verify and prepare standalone
        shell: pwsh
        env:
          DB_URL: ${{ secrets.DATABASE_URL }}
          AUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
        run: |
          Write-Host "=== VERIFYING STANDALONE BUILD ===" -ForegroundColor Cyan
          
          # Check standalone exists
          if (-not (Test-Path ".next/standalone")) {
            Write-Host "FATAL: .next/standalone not found" -ForegroundColor Red
            Get-ChildItem ".next" -ErrorAction SilentlyContinue
            exit 1
          }
          
          # Check server.js exists
          if (-not (Test-Path ".next/standalone/server.js")) {
            Write-Host "FATAL: server.js not found" -ForegroundColor Red
            Get-ChildItem ".next/standalone" -ErrorAction SilentlyContinue
            exit 1
          }
          
          Write-Host "server.js found!" -ForegroundColor Green
          
          # Copy static files
          Write-Host "Copying static files..." -ForegroundColor Yellow
          New-Item -ItemType Directory -Force -Path ".next/standalone/.next/static" | Out-Null
          Copy-Item -Recurse -Force ".next/static/*" ".next/standalone/.next/static/"
          
          # Copy public folder
          Write-Host "Copying public folder..." -ForegroundColor Yellow
          New-Item -ItemType Directory -Force -Path ".next/standalone/public" | Out-Null
          Copy-Item -Recurse -Force "public/*" ".next/standalone/public/"
          
          # Copy prisma folder (for schema)
          Write-Host "Copying prisma folder..." -ForegroundColor Yellow
          New-Item -ItemType Directory -Force -Path ".next/standalone/prisma" | Out-Null
          Copy-Item -Force "prisma/schema.prisma" ".next/standalone/prisma/"
          
          # Create minimal .env (DATABASE_URL will be set by config screen)
          Write-Host "Creating placeholder .env..." -ForegroundColor Yellow
          $envContent = @"
          NEXTAUTH_SECRET=$env:AUTH_SECRET
          NEXTAUTH_URL=http://localhost:3000
          "@
          $envContent | Out-File -FilePath ".next/standalone/.env" -Encoding ASCII
          
          Write-Host "Preparation complete!" -ForegroundColor Green

      - name: Package Main App
        run: npx electron-builder --win --x64 --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Rename main app artifacts
        shell: pwsh
        run: |
          if (Test-Path "dist/*.exe") {
            Get-ChildItem "dist/*.exe" | ForEach-Object {
              $newName = $_.Name -replace "Azadi POS", "AzadiPOS"
              if ($_.Name -ne $newName) {
                Rename-Item $_.FullName -NewName $newName
              }
            }
          }

      # Build Server Setup Tool
      - name: Install Server Setup dependencies
        working-directory: server-setup
        run: npm install --legacy-peer-deps

      - name: Package Server Setup Tool
        working-directory: server-setup
        run: npx electron-builder --win --x64 --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Move Server Setup artifacts
        shell: pwsh
        run: |
          if (Test-Path "server-setup/dist/*.exe") {
            Copy-Item "server-setup/dist/*.exe" "dist/"
          }

      - name: Show all artifacts
        shell: pwsh
        run: |
          Write-Host "=== BUILD ARTIFACTS ===" -ForegroundColor Cyan
          if (Test-Path "dist") {
            Get-ChildItem "dist" -Filter "*.exe" | ForEach-Object {
              $sizeMB = [math]::Round($_.Length / 1MB, 2)
              Write-Host "  $($_.Name) - $sizeMB MB" -ForegroundColor Green
            }
          }

      - name: Upload all artifacts
        uses: actions/upload-artifact@v4
        with:
          name: azadipos-windows-installers
          path: dist/*.exe
          retention-days: 30
