generator client {
    provider      = "prisma-client-js"
    binaryTargets = ["native", "windows", "debian-openssl-3.0.x"]
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model Company {
  id           String   @id @default(cuid())
  name         String
  createdAt    DateTime @default(now())
  
  // Return policy settings
  defaultReturnPeriodDays Int @default(30)
  
  categories   Category[]
  vendors      Vendor[]
  items        Item[]
  employees    Employee[]
  shifts       Shift[]
  transactions Transaction[]
  promotions   Promotion[]
  storeCredits StoreCredit[]
  receivingLogs ReceivingLog[]
  payouts      Payout[]
  returnPolicies ReturnPolicy[]
  customers    Customer[]
  loyaltyConfig LoyaltyConfig?
  giftCards    GiftCard[]
}

model Category {
  id              String   @id @default(cuid())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  name            String
  taxRate         Float    @default(0)
  isAgeRestricted Boolean  @default(false)
  returnPeriodDays Int     @default(30)
  createdAt       DateTime @default(now())
  
  items           Item[]
  
  @@unique([companyId, name])
}

model Vendor {
  id           String   @id @default(cuid())
  companyId    String
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  name         String
  contactInfo  String?
  createdAt    DateTime @default(now())
  
  items        Item[]
  receivingLogs ReceivingLog[]
  payouts      Payout[]
  
  @@unique([companyId, name])
}

model Item {
  id             String   @id @default(cuid())
  companyId      String
  company        Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  barcode        String
  name           String
  price          Float
  cost           Float    @default(0)
  categoryId     String?
  category       Category? @relation(fields: [categoryId], references: [id])
  vendorId       String?
  vendor         Vendor?  @relation(fields: [vendorId], references: [id])
  reorderPoint   Int      @default(0)
  isWeightPriced Boolean  @default(false)
  imageUrl       String?
  isActive       Boolean  @default(true)
  quantityOnHand Int      @default(0)
  createdAt      DateTime @default(now())
  
  // Return policy overrides (null means use category/company default)
  returnPeriodDays Int?
  noReturns        Boolean @default(false)
  
  transactionItems TransactionItem[]
  
  @@unique([companyId, barcode])
  @@index([companyId, isActive])
  @@index([companyId, name])
}

model Employee {
  id        String   @id @default(cuid())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  name      String
  pin       String?
  barcode   String?
  isManager Boolean  @default(false)
  inSales   Boolean  @default(true)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  
  shifts             Shift[]
  transactions       Transaction[] @relation("EmployeeTransactions")
  authorizedTransactions Transaction[] @relation("AuthorizedTransactions")
  issuedStoreCredits     StoreCredit[] @relation("IssuedByEmployee")
  authorizedStoreCredits StoreCredit[] @relation("AuthorizedByEmployee")
  closedShifts       Shift[] @relation("ShiftClosedBy")
  
  @@unique([companyId, barcode])
}

model Shift {
  id             String    @id @default(cuid())
  companyId      String
  company        Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employeeId     String
  employee       Employee  @relation(fields: [employeeId], references: [id])
  registerId     String?
  startTime      DateTime  @default(now())
  endTime        DateTime?
  openingBalance Float     @default(0)
  closingBalance Float?
  cashInjections Float     @default(0)
  status         String    @default("open")
  closedByEmployeeId String?
  closedBy       Employee? @relation("ShiftClosedBy", fields: [closedByEmployeeId], references: [id])
  
  transactions   Transaction[]
}

model Transaction {
  id                    String   @id @default(cuid())
  companyId             String
  company               Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  shiftId               String?
  shift                 Shift?   @relation(fields: [shiftId], references: [id])
  employeeId            String
  employee              Employee @relation("EmployeeTransactions", fields: [employeeId], references: [id])
  transactionNumber     String
  type                  String   @default("sale")
  subtotal              Float
  tax                   Float
  total                 Float
  paymentMethod         String   @default("cash")
  cashGiven             Float?
  changeDue             Float?
  status                String   @default("completed")
  linkedTransactionId   String?
  authorizedByEmployeeId String?
  authorizedBy          Employee? @relation("AuthorizedTransactions", fields: [authorizedByEmployeeId], references: [id])
  customerId            String?
  customer              Customer? @relation(fields: [customerId], references: [id])
  loyaltyPointsEarned   Int      @default(0)
  loyaltyPointsRedeemed Int      @default(0)
  createdAt             DateTime @default(now())
  
  items                 TransactionItem[]
  
  @@unique([companyId, transactionNumber])
}

model TransactionItem {
  id            String      @id @default(cuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  itemId        String
  item          Item        @relation(fields: [itemId], references: [id])
  itemName      String
  quantity      Float
  unitPrice     Float
  lineTotal     Float
  isWeightItem  Boolean     @default(false)
}

model Promotion {
  id         String    @id @default(cuid())
  companyId  String
  company    Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  name       String
  type       String
  configJson String?
  startDate  DateTime?
  endDate    DateTime?
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
}

model StoreCredit {
  id                      String    @id @default(cuid())
  companyId               String
  company                 Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  barcode                 String    @unique
  amount                  Float
  isUsed                  Boolean   @default(false)
  createdAt               DateTime  @default(now())
  usedAt                  DateTime?
  transactionId           String?
  redeemedTransactionId   String?
  description             String?
  issuedByEmployeeId      String?
  issuedBy                Employee? @relation("IssuedByEmployee", fields: [issuedByEmployeeId], references: [id])
  authorizedByEmployeeId  String?
  authorizedBy            Employee? @relation("AuthorizedByEmployee", fields: [authorizedByEmployeeId], references: [id])
}

model ReceivingLog {
  id              String   @id @default(cuid())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vendorId        String?
  vendor          Vendor?  @relation(fields: [vendorId], references: [id])
  invoiceImageUrl String?
  itemsJson       String?
  createdAt       DateTime @default(now())
}

model Payout {
  id              String   @id @default(cuid())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vendorId        String?
  vendor          Vendor?  @relation(fields: [vendorId], references: [id])
  amount          Float
  receiptImageUrl String?
  createdAt       DateTime @default(now())
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model ReturnPolicy {
  id              String   @id @default(cuid())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  targetType      String
  targetId        String
  returnPeriodDays Int?
  noReturns        Boolean @default(false)
  createdAt       DateTime @default(now())
  
  @@unique([companyId, targetType, targetId])
}

model Customer {
  id           String   @id @default(cuid())
  companyId    String
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  phone        String
  name         String
  email        String?
  loyaltyPoints Int     @default(0)
  totalSpent   Float    @default(0)
  visitCount   Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  transactions Transaction[]
  
  @@unique([companyId, phone])
}

model LoyaltyConfig {
  id                  String   @id @default(cuid())
  companyId           String   @unique
  company             Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  pointsPerDollar     Float    @default(1)
  rewardTiersJson     String?
  isEnabled           Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model GiftCard {
  id           String    @id @default(cuid())
  companyId    String
  company      Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  barcode      String    @unique
  initialValue Float
  balance      Float
  isActive     Boolean   @default(true)
  purchasedAt  DateTime?
  purchaseTransactionId String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  usageHistory GiftCardUsage[]
}

model GiftCardUsage {
  id            String   @id @default(cuid())
  giftCardId    String
  giftCard      GiftCard @relation(fields: [giftCardId], references: [id], onDelete: Cascade)
  transactionId String?
  amount        Float
  balanceAfter  Float
  createdAt     DateTime @default(now())
}

model AuditTrail {
  id           String   @id @default(cuid())
  companyId    String
  action       String
  entityType   String
  entityId     String?
  description  String
  employeeId   String?
  employeeName String?
  authorizedById String?
  authorizedByName String?
  metadata     String?
  createdAt    DateTime @default(now())
  
  @@index([companyId, createdAt])
  @@index([companyId, action])
}
