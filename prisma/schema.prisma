generator client {
    provider      = "prisma-client-js"
    binaryTargets = ["native", "windows", "debian-openssl-3.0.x"]
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model Company {
  id           String   @id @default(cuid())
  name         String
  createdAt    DateTime @default(now())
  
  defaultReturnPeriodDays Int @default(30)
  
  categories   Category[]
  items        Item[]
  employees    Employee[]
  shifts       Shift[]
  transactions Transaction[]
  promotions   Promotion[]
  vendors      Vendor[]
  storeCredits StoreCredit[]
  receivingLogs ReceivingLog[]
  payouts      Payout[]
  returnPolicies ReturnPolicy[]
  giftCards    GiftCard[]
  customers    Customer[]
  auditTrails  AuditTrail[]
  loyaltyConfig LoyaltyConfig?
}

model Category {
  id              String   @id @default(cuid())
  name            String
  taxRate         Float    @default(0)
  isAgeRestricted Boolean  @default(false)
  returnPeriodDays Int?
  noReturns       Boolean  @default(false)
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  items           Item[]
  returnPolicies  ReturnPolicy[]

  @@unique([companyId, name])
}

model Vendor {
  id          String  @id @default(cuid())
  name        String
  contactInfo String?
  email       String?
  phone       String?
  companyId   String
  company     Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  items       Item[]
  receivingLogs ReceivingLog[]

  @@unique([companyId, name])
}

model Item {
  id              String    @id @default(cuid())
  name            String
  barcode         String
  price           Float
  cost            Float     @default(0)
  quantityOnHand  Int       @default(0)
  reorderPoint    Int       @default(10)
  isWeightPriced  Boolean   @default(false)
  imageUrl        String?
  isActive        Boolean   @default(true)
  returnPeriodDays Int?
  noReturns       Boolean   @default(false)
  companyId       String
  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  categoryId      String?
  category        Category? @relation(fields: [categoryId], references: [id])
  vendorId        String?
  vendor          Vendor?   @relation(fields: [vendorId], references: [id])
  transactionItems TransactionItem[]
  returnPolicies  ReturnPolicy[]
  costHistory     CostHistory[]

  @@unique([companyId, barcode])
}

model CostHistory {
  id        String   @id @default(cuid())
  itemId    String
  item      Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  vendorId  String?
  vendorName String?
  cost      Float
  quantity  Int
  createdAt DateTime @default(now())
}

model Employee {
  id          String   @id @default(cuid())
  name        String
  barcode     String?  @unique
  isManager   Boolean  @default(false)
  isActive    Boolean  @default(true)
  inSales     Boolean  @default(true)
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  shifts      Shift[]
  transactions Transaction[]
  authorizedTransactions Transaction[] @relation("AuthorizedBy")
  issuedStoreCredits StoreCredit[] @relation("IssuedBy")
  authorizedStoreCredits StoreCredit[] @relation("AuthorizedStoreCredit")
  auditTrails AuditTrail[]
  authorizedAuditTrails AuditTrail[] @relation("AuthorizedAuditTrail")
  closedShifts Shift[] @relation("ShiftClosedBy")

  @@unique([companyId, barcode])
}

model Shift {
  id             String    @id @default(cuid())
  registerId     String?
  startTime      DateTime  @default(now())
  endTime        DateTime?
  openingBalance Float     @default(0)
  closingBalance Float?
  cashInjections Float     @default(0)
  status         String    @default("open")
  employeeId     String
  employee       Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  companyId      String
  company        Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  closedByEmployeeId String?
  closedBy       Employee? @relation("ShiftClosedBy", fields: [closedByEmployeeId], references: [id])
  transactions   Transaction[]
}

model Transaction {
  id                    String   @id @default(cuid())
  transactionNumber     String
  type                  String   @default("sale")
  total                 Float
  subtotal              Float    @default(0)
  tax                   Float    @default(0)
  paymentMethod         String   @default("cash")
  cashAmount            Float?
  cardAmount            Float?
  cashGiven             Float?
  changeDue             Float?
  status                String   @default("completed")
  linkedTransactionId   String?
  loyaltyPointsEarned   Int      @default(0)
  loyaltyPointsRedeemed Int      @default(0)
  createdAt             DateTime @default(now())
  employeeId            String
  employee              Employee @relation(fields: [employeeId], references: [id])
  authorizedById        String?
  authorizedBy          Employee? @relation("AuthorizedBy", fields: [authorizedById], references: [id])
  shiftId               String?
  shift                 Shift?   @relation(fields: [shiftId], references: [id])
  companyId             String
  company               Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customerId            String?
  customer              Customer? @relation(fields: [customerId], references: [id])
  items                 TransactionItem[]
  storeCredits          StoreCredit[]
  redeemedStoreCredits  StoreCredit[] @relation("RedeemedTransaction")
  giftCardUsages        GiftCardUsage[]

  @@unique([companyId, transactionNumber])
}

model TransactionItem {
  id            String      @id @default(cuid())
  quantity      Float
  price         Float
  name          String
  barcode       String?
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  itemId        String?
  item          Item?       @relation(fields: [itemId], references: [id])
}

model Promotion {
  id          String    @id @default(cuid())
  name        String
  type        String
  config      Json
  startDate   DateTime?
  endDate     DateTime?
  isActive    Boolean   @default(true)
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model StoreCredit {
  id            String   @id @default(cuid())
  barcode       String   @unique
  amount        Float
  isUsed        Boolean  @default(false)
  usedAt        DateTime?
  createdAt     DateTime @default(now())
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactionId String?
  transaction   Transaction? @relation(fields: [transactionId], references: [id])
  redeemedTransactionId String?
  redeemedTransaction   Transaction? @relation("RedeemedTransaction", fields: [redeemedTransactionId], references: [id])
  description   String?
  issuedByEmployeeId String?
  issuedByEmployee   Employee? @relation("IssuedBy", fields: [issuedByEmployeeId], references: [id])
  authorizedByEmployeeId String?
  authorizedByEmployee   Employee? @relation("AuthorizedStoreCredit", fields: [authorizedByEmployeeId], references: [id])
}

model ReceivingLog {
  id              String   @id @default(cuid())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vendorId        String?
  vendor          Vendor?  @relation(fields: [vendorId], references: [id])
  itemsJson       String?
  invoiceImageUrl String?
  createdAt       DateTime @default(now())
}

model Payout {
  id          String   @id @default(cuid())
  amount      Float
  reason      String
  createdAt   DateTime @default(now())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model ReturnPolicy {
  id          String   @id @default(cuid())
  type        String
  itemId      String?
  item        Item?    @relation(fields: [itemId], references: [id], onDelete: Cascade)
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  returnPeriodDays Int?
  noReturns   Boolean  @default(false)
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model GiftCard {
  id                    String   @id @default(cuid())
  barcode               String   @unique
  initialValue          Float
  balance               Float
  isPurchased           Boolean  @default(false)
  purchasedAt           DateTime?
  purchaseTransactionId String?
  isActive              Boolean  @default(true)
  expiresAt             DateTime?
  createdAt             DateTime @default(now())
  companyId             String
  company               Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  usageHistory          GiftCardUsage[]
}

model GiftCardUsage {
  id            String      @id @default(cuid())
  giftCardId    String
  giftCard      GiftCard    @relation(fields: [giftCardId], references: [id], onDelete: Cascade)
  transactionId String?
  transaction   Transaction? @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  amount        Float
  balanceAfter  Float
  createdAt     DateTime    @default(now())
}

model Customer {
  id            String   @id @default(cuid())
  name          String?
  phone         String
  email         String?
  loyaltyPoints Int      @default(0)
  totalSpent    Float    @default(0)
  visitCount    Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions  Transaction[]

  @@unique([companyId, phone])
}

model AuditTrail {
  id              String   @id @default(cuid())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  action          String
  entityType      String
  entityId        String?
  description     String
  metadata        Json?
  employeeId      String?
  employee        Employee? @relation(fields: [employeeId], references: [id])
  employeeName    String?
  authorizedById  String?
  authorizedBy    Employee? @relation("AuthorizedAuditTrail", fields: [authorizedById], references: [id])
  authorizedByName String?
  createdAt       DateTime @default(now())

  @@index([companyId, createdAt])
  @@index([companyId, action])
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LoyaltyConfig {
  id              String   @id @default(cuid())
  companyId       String   @unique
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  pointsPerDollar Float    @default(1)
  rewardTiersJson String?
  isEnabled       Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
