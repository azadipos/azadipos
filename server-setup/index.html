<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AzadiPOS Server Setup</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 850px;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
      color: #4ade80;
    }
    .subtitle {
      text-align: center;
      color: #94a3b8;
      margin-bottom: 30px;
    }
    .card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }
    .card h2 {
      color: #4ade80;
      margin-bottom: 16px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .step-number {
      background: #4ade80;
      color: #1a1a2e;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.9rem;
      flex-shrink: 0;
    }
    .step-number.done {
      background: #22c55e;
    }
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      color: #94a3b8;
      font-size: 0.9rem;
    }
    input {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(0,0,0,0.3);
      color: #fff;
      font-size: 1rem;
    }
    input:focus {
      outline: none;
      border-color: #4ade80;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #4ade80;
      color: #1a1a2e;
      font-weight: 600;
    }
    .btn-primary:hover {
      background: #22c55e;
    }
    .btn-primary:disabled {
      background: #4b5563;
      color: #9ca3af;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }
    .btn-secondary:hover {
      background: rgba(255,255,255,0.2);
    }
    .btn-danger {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.5);
    }
    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.3);
    }
    .status {
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      font-size: 0.9rem;
    }
    .status.success {
      background: rgba(74, 222, 128, 0.2);
      border: 1px solid #4ade80;
      color: #4ade80;
    }
    .status.error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      color: #ef4444;
    }
    .status.info {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid #3b82f6;
      color: #93c5fd;
    }
    .status.warning {
      background: rgba(251, 191, 36, 0.2);
      border: 1px solid #fbbf24;
      color: #fbbf24;
    }
    .connection-string {
      background: rgba(0,0,0,0.5);
      padding: 16px;
      border-radius: 8px;
      font-family: monospace;
      word-break: break-all;
      margin: 12px 0;
      border: 1px solid rgba(74, 222, 128, 0.3);
    }
    .copy-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
    }
    .ip-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .ip-tag {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid #3b82f6;
      padding: 6px 12px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 0.85rem;
    }
    .info-box {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .info-box h3 {
      color: #93c5fd;
      margin-bottom: 8px;
    }
    .info-box p {
      color: #94a3b8;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    .info-box a {
      color: #4ade80;
    }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #4ade80;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .hidden { display: none; }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 12px;
    }
    .progress-bar-fill {
      height: 100%;
      background: #4ade80;
      transition: width 0.3s ease;
    }
    .progress-text {
      text-align: center;
      margin-top: 8px;
      color: #94a3b8;
      font-size: 0.85rem;
    }
    .postgres-status {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .postgres-status.installed {
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.3);
    }
    .postgres-status.not-installed {
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.3);
    }
    .postgres-status .icon {
      font-size: 2rem;
    }
    .postgres-status .text h3 {
      color: #fff;
      margin-bottom: 4px;
    }
    .postgres-status .text p {
      color: #94a3b8;
      font-size: 0.85rem;
    }
    .install-section {
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }
    .install-section h4 {
      color: #fbbf24;
      margin-bottom: 12px;
    }
    .buttons-row {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üñ•Ô∏è AzadiPOS Server Setup</h1>
    <p class="subtitle">Configure your PostgreSQL database server for the POS system</p>

    <!-- Step 0: PostgreSQL Check/Install -->
    <div class="card">
      <h2><span class="step-number" id="step0Num">0</span> PostgreSQL Installation</h2>
      
      <div id="postgresStatus" class="postgres-status">
        <span class="icon">‚è≥</span>
        <div class="text">
          <h3>Checking...</h3>
          <p>Looking for PostgreSQL installation</p>
        </div>
      </div>
      
      <div id="installSection" class="install-section hidden">
        <h4>üì• Auto-Install PostgreSQL</h4>
        <p style="color: #94a3b8; margin-bottom: 12px; font-size: 0.9rem;">
          We can automatically download and install PostgreSQL for you. You'll need to set a password for the database.
        </p>
        
        <div class="form-group">
          <label>Set PostgreSQL Password</label>
          <input type="password" id="installPassword" placeholder="Choose a secure password">
          <p style="color: #64748b; font-size: 0.75rem; margin-top: 4px;">Remember this password - you'll need it to connect!</p>
        </div>
        
        <div id="downloadProgress" class="hidden">
          <div class="progress-bar">
            <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
          </div>
          <p class="progress-text" id="progressText">Downloading...</p>
        </div>
        
        <div id="installStatus"></div>
        
        <div class="buttons-row">
          <button class="btn-primary" id="downloadBtn" onclick="downloadPostgres()">Download PostgreSQL (~300MB)</button>
          <button class="btn-secondary" onclick="openManualDownload()">Download Manually</button>
        </div>
      </div>
    </div>

    <!-- Step 1: PostgreSQL Connection -->
    <div class="card">
      <h2><span class="step-number">1</span> PostgreSQL Connection</h2>
      <div class="form-row">
        <div class="form-group">
          <label>Host</label>
          <input type="text" id="host" value="localhost" placeholder="localhost or IP">
        </div>
        <div class="form-group">
          <label>Port</label>
          <input type="text" id="port" value="5432" placeholder="5432">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="username" value="postgres" placeholder="postgres">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="password" placeholder="Your PostgreSQL password">
        </div>
      </div>
      <button class="btn-primary" id="testConnection">Test Connection</button>
      <div id="connectionStatus"></div>
    </div>

    <!-- Step 2: Create Database -->
    <div class="card">
      <h2><span class="step-number">2</span> Create Database</h2>
      <div class="form-group">
        <label>Database Name</label>
        <input type="text" id="dbName" value="azadipos" placeholder="azadipos">
      </div>
      <button class="btn-primary" id="createDb" disabled>Create Database</button>
      <div id="dbStatus"></div>
    </div>

    <!-- Step 3: Setup Tables -->
    <div class="card">
      <h2><span class="step-number">3</span> Setup Database Tables</h2>
      <p style="color: #94a3b8; margin-bottom: 12px;">This will create all the tables needed for the POS system.</p>
      <button class="btn-primary" id="setupTables" disabled>Setup Tables</button>
      <div id="tableStatus"></div>
    </div>

    <!-- Step 4: Connection Info -->
    <div class="card">
      <h2><span class="step-number">4</span> Connection Information for Terminals</h2>
      <p style="color: #94a3b8; margin-bottom: 12px;">Share this information with your POS terminals:</p>
      
      <label>This Computer's IP Addresses:</label>
      <div class="ip-list" id="ipList">Loading...</div>
      
      <label style="margin-top: 16px;">Connection String (for terminals):</label>
      <div class="connection-string" id="connectionString">Complete steps 1-3 first</div>
      <button class="btn-secondary copy-btn" id="copyBtn" disabled>
        üìã Copy to Clipboard
      </button>
      
      <div class="status info" style="margin-top: 16px;">
        <strong>üí° Tip:</strong> Use your IP address (not "localhost") when configuring other computers to connect to this server.
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    let connectionValid = false;
    let dbCreated = false;
    let postgresInstalled = false;

    // Load saved config on startup
    async function loadSavedConfig() {
      const result = await ipcRenderer.invoke('load-config');
      if (result.success && result.config) {
        document.getElementById('host').value = result.config.host || 'localhost';
        document.getElementById('port').value = result.config.port || '5432';
        document.getElementById('username').value = result.config.username || 'postgres';
        document.getElementById('dbName').value = result.config.dbName || 'azadipos';
      }
    }

    // Check PostgreSQL installation
    async function checkPostgres() {
      const statusDiv = document.getElementById('postgresStatus');
      const installSection = document.getElementById('installSection');
      const step0Num = document.getElementById('step0Num');
      
      const result = await ipcRenderer.invoke('check-postgres');
      
      if (result.installed) {
        postgresInstalled = true;
        statusDiv.className = 'postgres-status installed';
        statusDiv.innerHTML = `
          <span class="icon">‚úÖ</span>
          <div class="text">
            <h3>PostgreSQL Installed</h3>
            <p>Version ${result.version} found at ${result.path}</p>
          </div>
        `;
        step0Num.classList.add('done');
        step0Num.textContent = '‚úì';
        installSection.classList.add('hidden');
      } else {
        statusDiv.className = 'postgres-status not-installed';
        statusDiv.innerHTML = `
          <span class="icon">‚ö†Ô∏è</span>
          <div class="text">
            <h3>PostgreSQL Not Found</h3>
            <p>PostgreSQL needs to be installed to run the server</p>
          </div>
        `;
        installSection.classList.remove('hidden');
      }
    }

    // Download PostgreSQL
    async function downloadPostgres() {
      const btn = document.getElementById('downloadBtn');
      const progressDiv = document.getElementById('downloadProgress');
      const statusDiv = document.getElementById('installStatus');
      const password = document.getElementById('installPassword').value;
      
      if (!password || password.length < 4) {
        statusDiv.innerHTML = '<div class="status error">Please enter a password (at least 4 characters)</div>';
        return;
      }
      
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span>Downloading...';
      progressDiv.classList.remove('hidden');
      statusDiv.innerHTML = '';
      
      // Listen for progress updates
      ipcRenderer.on('download-progress', (event, data) => {
        document.getElementById('progressFill').style.width = `${data.percent}%`;
        const mb = (data.downloaded / 1024 / 1024).toFixed(1);
        const totalMb = (data.total / 1024 / 1024).toFixed(1);
        document.getElementById('progressText').textContent = `Downloading: ${mb}MB / ${totalMb}MB (${data.percent}%)`;
      });
      
      const downloadResult = await ipcRenderer.invoke('download-postgres');
      
      if (!downloadResult.success) {
        statusDiv.innerHTML = `<div class="status error">Download failed: ${downloadResult.error}</div>`;
        btn.disabled = false;
        btn.innerHTML = 'Download PostgreSQL (~300MB)';
        return;
      }
      
      // Start installation
      document.getElementById('progressText').textContent = 'Installing PostgreSQL (this may take a few minutes)...';
      btn.innerHTML = '<span class="loading"></span>Installing...';
      
      const installResult = await ipcRenderer.invoke('install-postgres', password);
      
      if (installResult.success) {
        statusDiv.innerHTML = '<div class="status success">‚úì PostgreSQL installed successfully!</div>';
        document.getElementById('password').value = password;
        
        // Recheck installation
        await checkPostgres();
        
        statusDiv.innerHTML += '<div class="status info" style="margin-top: 8px;">üéâ PostgreSQL is ready! Your password has been filled in below. Click "Test Connection" to continue.</div>';
      } else {
        statusDiv.innerHTML = `<div class="status error">Installation failed: ${installResult.error}</div>`;
      }
      
      btn.disabled = false;
      btn.innerHTML = 'Download PostgreSQL (~300MB)';
      progressDiv.classList.add('hidden');
    }

    // Open manual download page
    function openManualDownload() {
      require('electron').shell.openExternal('https://www.postgresql.org/download/windows/');
    }

    // Get local IPs
    async function loadLocalIPs() {
      const ips = await ipcRenderer.invoke('get-local-ips');
      const ipList = document.getElementById('ipList');
      if (ips.length === 0) {
        ipList.innerHTML = '<span class="ip-tag">localhost (127.0.0.1)</span>';
      } else {
        ipList.innerHTML = ips.map(ip => 
          `<span class="ip-tag">${ip.name}: ${ip.address}</span>`
        ).join('');
      }
    }

    // Test connection
    document.getElementById('testConnection').addEventListener('click', async () => {
      const btn = document.getElementById('testConnection');
      const status = document.getElementById('connectionStatus');
      
      btn.innerHTML = '<span class="loading"></span>Testing...';
      btn.disabled = true;
      
      const config = {
        host: document.getElementById('host').value,
        port: document.getElementById('port').value,
        username: document.getElementById('username').value,
        password: document.getElementById('password').value,
      };
      
      const result = await ipcRenderer.invoke('test-connection', config);
      
      if (result.success) {
        status.className = 'status success';
        status.textContent = '‚úì Connected to PostgreSQL successfully!';
        connectionValid = true;
        document.getElementById('createDb').disabled = false;
      } else {
        status.className = 'status error';
        status.textContent = '‚úó Connection failed: ' + result.error;
        connectionValid = false;
      }
      
      btn.innerHTML = 'Test Connection';
      btn.disabled = false;
    });

    // Create database
    document.getElementById('createDb').addEventListener('click', async () => {
      const btn = document.getElementById('createDb');
      const status = document.getElementById('dbStatus');
      
      btn.innerHTML = '<span class="loading"></span>Creating...';
      btn.disabled = true;
      
      const config = {
        host: document.getElementById('host').value,
        port: document.getElementById('port').value,
        username: document.getElementById('username').value,
        password: document.getElementById('password').value,
        dbName: document.getElementById('dbName').value,
      };
      
      const result = await ipcRenderer.invoke('create-database', config);
      
      if (result.success) {
        status.className = 'status success';
        status.textContent = result.created 
          ? '‚úì Database created successfully!' 
          : '‚úì Database already exists!';
        dbCreated = true;
        document.getElementById('setupTables').disabled = false;
        
        // Save config
        await ipcRenderer.invoke('save-config', config);
      } else {
        status.className = 'status error';
        status.textContent = '‚úó Failed: ' + result.error;
      }
      
      btn.innerHTML = 'Create Database';
      btn.disabled = !connectionValid;
    });

    // Setup tables
    document.getElementById('setupTables').addEventListener('click', async () => {
      const btn = document.getElementById('setupTables');
      const status = document.getElementById('tableStatus');
      
      btn.innerHTML = '<span class="loading"></span>Setting up tables...';
      btn.disabled = true;
      
      const config = {
        host: document.getElementById('host').value,
        port: document.getElementById('port').value,
        username: document.getElementById('username').value,
        password: document.getElementById('password').value,
        dbName: document.getElementById('dbName').value,
      };
      
      const result = await ipcRenderer.invoke('setup-tables', config);
      
      if (result.success) {
        status.className = 'status success';
        status.textContent = '‚úì Database tables created successfully!';
        
        // Update connection string
        const connStr = await ipcRenderer.invoke('generate-connection-string', config);
        document.getElementById('connectionString').textContent = connStr;
        document.getElementById('copyBtn').disabled = false;
      } else {
        status.className = 'status error';
        status.textContent = '‚úó Failed: ' + result.error;
      }
      
      btn.innerHTML = 'Setup Tables';
      btn.disabled = !dbCreated;
    });

    // Copy connection string
    document.getElementById('copyBtn').addEventListener('click', () => {
      const connStr = document.getElementById('connectionString').textContent;
      navigator.clipboard.writeText(connStr);
      
      const btn = document.getElementById('copyBtn');
      btn.textContent = '‚úì Copied!';
      setTimeout(() => {
        btn.innerHTML = 'üìã Copy to Clipboard';
      }, 2000);
    });

    // Initialize
    checkPostgres();
    loadSavedConfig();
    loadLocalIPs();
  </script>
</body>
</html>
